---
interface Props {
  classname?: string;
}
const { classname } = Astro.props;
---

<div class={`place-self-left flex items-center ${classname || ""}`}>
  <label for="theme-toggle" class="sr-only"> Cambiar tema </label>

  <button
    id="theme-toggle"
    type="button"
    aria-label="Cambiar entre tema claro y oscuro"
    class="relative w-14 h-8 rounded-full
           bg-slate-200 dark:bg-gray-700
           border-2 border-slate-300 dark:border-gray-600
           transition-all duration-300 ease-in-out
           focus:outline-none focus:ring-2 focus:ring-cyan-500/50
           hover:scale-105 active:scale-95
           hover:border-cyan-400 dark:hover:border-cyan-500
           cursor-pointer shadow-sm"
  >
    <!-- Slider circle -->
    <span
      id="theme-slider"
      class="absolute top-0.5 left-0.5 w-6 h-6 rounded-full
             bg-white dark:bg-gray-900
             shadow-md
             transition-all duration-300 ease-in-out
             flex items-center justify-center"
      style="transform: translateX(0);"
    >
      <!-- Sun icon (light mode) -->
      <svg
        id="sun-icon"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-4 h-4 text-yellow-500
               transition-opacity duration-300
               opacity-100 dark:opacity-0"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
        ></path>
      </svg>

      <!-- Moon icon (dark mode) -->
      <svg
        id="moon-icon"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-4 h-4 text-cyan-300 absolute
               transition-opacity duration-300
               opacity-0 dark:opacity-100"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
        ></path>
      </svg>
    </span>
  </button>
</div>

<script is:inline>
  (function () {
    // Evitar múltiples inicializaciones
    if (window.__themeToggleInitialized) return;
    window.__themeToggleInitialized = true;

    function initThemeToggle() {
      const toggle = document.getElementById("theme-toggle");
      const root = document.documentElement;

      if (!toggle) {
        console.warn("Theme toggle not found");
        return;
      }

      const getSystemTheme = () =>
        window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light";

      const slider = document.getElementById("theme-slider");
      const sunIcon = document.getElementById("sun-icon");
      const moonIcon = document.getElementById("moon-icon");

      const applyTheme = (isDark) => {
        // Forzar sincronización inmediata
        if (isDark) {
          root.classList.add("dark");
          root.setAttribute("data-theme", "dark");
          if (slider) {
            slider.style.transform = "translateX(1.5rem)";
          }
          // Mostrar icono de luna, ocultar icono de sol
          if (sunIcon) sunIcon.style.opacity = "0";
          if (moonIcon) moonIcon.style.opacity = "1";
        } else {
          root.classList.remove("dark");
          root.removeAttribute("data-theme");
          if (slider) {
            slider.style.transform = "translateX(0)";
          }
          // Mostrar icono de sol, ocultar icono de luna
          if (sunIcon) sunIcon.style.opacity = "1";
          if (moonIcon) moonIcon.style.opacity = "0";
        }

        // Forzar repaint y reflow
        void root.offsetHeight;
        document.body?.offsetHeight;

        // Guardar como 'dark' o 'light', no 'auto'
        localStorage.setItem("theme", isDark ? "dark" : "light");
      };

      const toggleTheme = (e) => {
        e.preventDefault();
        e.stopPropagation();

        const isDark = root.classList.contains("dark");
        applyTheme(!isDark);
      };

      // Inicializar tema al cargar
      // Leer el tema actual del DOM (ya aplicado por el script del Layout)
      // Si hay un tema guardado, usarlo; si no, usar el del sistema
      const savedTheme = localStorage.getItem("theme");
      let initialTheme;

      if (savedTheme === "dark") {
        initialTheme = true;
      } else if (savedTheme === "light") {
        initialTheme = false;
      } else {
        // Si es 'auto' o no hay guardado, usar el estado actual del DOM
        initialTheme = root.classList.contains("dark");
        // Guardar el tema detectado como preferencia
        localStorage.setItem("theme", initialTheme ? "dark" : "light");
      }

      // Aplicar tema inicial inmediatamente (sincroniza el slider y los iconos con el estado actual)
      // Usar requestAnimationFrame para asegurar que el DOM esté listo
      const initTheme = () => {
        applyTheme(initialTheme);
      };

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTheme);
      } else {
        // Si el DOM ya está listo, ejecutar inmediatamente
        requestAnimationFrame(initTheme);
      }

      // Listener para clicks con capture para asegurar que se ejecute
      toggle.addEventListener("click", toggleTheme, {
        capture: true,
        once: false,
      });

      // Listener para cambios del sistema (si el usuario no ha cambiado manualmente)
      const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
      mediaQuery.addEventListener("change", (e) => {
        // Solo seguir el sistema si el usuario no ha guardado una preferencia manual
        const saved = localStorage.getItem("theme");
        if (saved !== "dark" && saved !== "light") {
          applyTheme(e.matches);
        }
      });
    }

    // Ejecutar inmediatamente si el DOM ya está listo, o esperar a que esté listo
    // Usar múltiples estrategias para asegurar que se ejecute lo antes posible
    const tryInit = () => {
      if (document.getElementById("theme-toggle")) {
        initThemeToggle();
      } else {
        // Si el elemento aún no existe, esperar un poco más
        requestAnimationFrame(() => {
          if (document.getElementById("theme-toggle")) {
            initThemeToggle();
          } else {
            // Último intento después de un pequeño delay
            setTimeout(tryInit, 50);
          }
        });
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", tryInit);
    } else {
      // Si el DOM ya está listo, intentar inmediatamente
      tryInit();
    }
  })();
</script>
