---
interface Props {
  classname?: string;
}
const { classname } = Astro.props;
---

<div class={`place-self-left flex items-center ${classname || ""}`}>
  <label for="theme-toggle" class="sr-only" data-i18n="theme_toggle_label"
    >Cambiar tema</label
  >

  <button
    class="theme-toggle-btn relative w-14 h-8 rounded-full
           outline-none
           bg-cyan-400 dark:bg-gray-700
           transition-all duration-300 ease-in-out
           hover:border-cyan-500 dark:hover:border-cyan-500
           cursor-pointer shadow-md shadow-cyan-500/20 dark:shadow-none"
    type="button"
    aria-label="Cambiar entre tema claro y oscuro"
    data-i18n-attr="aria-label:theme_toggle_aria"
  >
    <!-- Slider circle -->
    <span
      class="theme-toggle-slider absolute top-1 left-0.5 w-6 h-6 rounded-full
             bg-white dark:bg-gray-900
             shadow-md
             transition-all duration-300 ease-in-out
             flex items-center justify-center"
      style="transform: translateX(0);"
    >
      <!-- Sun icon (light mode) -->
      <svg
        class="theme-toggle-sun-icon w-4 h-4 text-yellow-500
               transition-opacity duration-300
               opacity-100 dark:opacity-0"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
        ></path>
      </svg>

      <!-- Moon icon (dark mode) -->
      <svg
        class="theme-toggle-moon-icon w-4 h-4 text-cyan-300 absolute
               transition-opacity duration-300
               opacity-0 dark:opacity-100"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
        ></path>
      </svg>
    </span>
  </button>
</div>

<script is:inline>
  (function () {
    // Avoid multiple global initializations
    if (window.__themeToggleInitialized) return;
    window.__themeToggleInitialized = true;

    const root = document.documentElement;
    let themeToggleHandler = null;
    let mediaQueryListener = null;

    const applyTheme = (isDark) => {
      // Force immediate sync
      if (isDark) {
        root.classList.add("dark");
        root.setAttribute("data-theme", "dark");
      } else {
        root.classList.remove("dark");
        root.removeAttribute("data-theme");
      }

      // Update all toggles
      const toggles = document.querySelectorAll(".theme-toggle-btn");
      toggles.forEach((toggle) => {
        const slider = toggle.querySelector(".theme-toggle-slider");
        const sunIcon = toggle.querySelector(".theme-toggle-sun-icon");
        const moonIcon = toggle.querySelector(".theme-toggle-moon-icon");

        if (isDark) {
          if (slider) slider.style.transform = "translateX(1.5rem)";
          if (sunIcon) sunIcon.style.opacity = "0";
          if (moonIcon) moonIcon.style.opacity = "1";
        } else {
          if (slider) slider.style.transform = "translateX(0)";
          if (sunIcon) sunIcon.style.opacity = "1";
          if (moonIcon) moonIcon.style.opacity = "0";
        }
      });

      // Force repaint and reflow
      void root.offsetHeight;
      document.body?.offsetHeight;

      // Save as 'dark' or 'light', not 'auto'
      localStorage.setItem("theme", isDark ? "dark" : "light");
    };

    const toggleTheme = (e) => {
      e.preventDefault();
      e.stopPropagation();

      const isDark = root.classList.contains("dark");
      applyTheme(!isDark);
    };

    function initThemeToggle() {
      // Find all toggles (there may be multiple instances)
      const toggles = document.querySelectorAll(".theme-toggle-btn");

      if (toggles.length === 0) {
        // If no toggles, wait for them to mount (they may be in the drawer)
        setTimeout(initThemeToggle, 100);
        return;
      }

      // Remove previous listeners if any
      if (themeToggleHandler) {
        toggles.forEach((toggle) => {
          toggle.removeEventListener("click", themeToggleHandler);
        });
      }

      // Create new handler
      themeToggleHandler = toggleTheme;

      // Add listeners to all toggles (only once)
      toggles.forEach((toggle) => {
        // Check if it already has the listener
        if (!toggle.dataset.themeListenerAdded) {
          toggle.addEventListener("click", themeToggleHandler, {
            capture: true,
            once: false,
          });
          toggle.dataset.themeListenerAdded = "true";
        }
      });

      // Initialize theme on load (only once)
      if (!window.__themeInitialized) {
        window.__themeInitialized = true;

        const savedTheme = localStorage.getItem("theme");
        let initialTheme;

        if (savedTheme === "dark") {
          initialTheme = true;
        } else if (savedTheme === "light") {
          initialTheme = false;
        } else {
          // If 'auto' or nothing saved, use current DOM state
          initialTheme = root.classList.contains("dark");
          // Save detected theme as preference
          localStorage.setItem("theme", initialTheme ? "dark" : "light");
        }

        // Apply initial theme
        applyTheme(initialTheme);

        // Listener for system changes (only once)
        const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
        mediaQueryListener = (e) => {
          const saved = localStorage.getItem("theme");
          if (saved !== "dark" && saved !== "light") {
            applyTheme(e.matches);
          }
        };
        mediaQuery.addEventListener("change", mediaQueryListener);
      }
    }

    // Run immediately if DOM is ready, or wait until ready
    const tryInit = () => {
      if (document.querySelector(".theme-toggle-btn")) {
        initThemeToggle();
      } else {
        // If element does not exist yet, wait a bit longer
        requestAnimationFrame(() => {
          if (document.querySelector(".theme-toggle-btn")) {
            initThemeToggle();
          } else {
            // Last attempt after a short delay
            setTimeout(tryInit, 50);
          }
        });
      }
    };

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", tryInit);
    } else {
      // If DOM is already ready, try immediately
      tryInit();
    }

    // Also listen when drawer is opened
    window.addEventListener("drawer-opened", () => {
      setTimeout(initThemeToggle, 150);
    });
  })();
</script>
