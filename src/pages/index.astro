---
// Página de redirección según el idioma del navegador
const supportedLanguages = ['es', 'en', 'ru', 'zh'];
const defaultLang = 'es';

// Obtener el idioma preferido del navegador
function getBrowserLanguage(headers: Headers): string {
  const acceptLanguage = headers.get('accept-language') || '';
  
  // Extraer el idioma principal (ej: 'es' de 'es-ES,es;q=0.9')
  const languages = acceptLanguage
    .split(',')
    .map(lang => lang.split(';')[0].trim().toLowerCase().split('-')[0]);
  
  // Buscar el primer idioma soportado
  for (const lang of languages) {
    if (supportedLanguages.includes(lang)) {
      return lang;
    }
  }
  
  return defaultLang;
}

const browserLang = getBrowserLanguage(Astro.request.headers);
const base = import.meta.env.BASE_URL || '';
// Asegurar que base termine con / si no está vacío
const basePath = base && !base.endsWith('/') ? base + '/' : base;
const redirectUrl = `${basePath}${browserLang}`;
---

<!doctype html>
<html lang={browserLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="refresh" content={`0; url=${redirectUrl}`} />
    <link rel="canonical" href={redirectUrl} />
    <title>Redirecting...</title>
    <script is:inline define:vars={{ basePath }}>
      // Redirección inmediata con JavaScript como respaldo
      (function() {
        const lang = navigator.language || navigator.userLanguage || '';
        const supported = ['es', 'en', 'ru', 'zh'];
        const defaultLang = 'es';
        const browserLang = supported.find(l => lang.toLowerCase().startsWith(l)) || defaultLang;
        const path = (basePath || '') + browserLang;
        window.location.replace(path);
      })();
    </script>
  </head>
  <body>
    <p>Redirigiendo a <a href={redirectUrl}>{browserLang}</a>...</p>
  </body>
</html>
